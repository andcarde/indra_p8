<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/biblioteca.css">
    <link rel="stylesheet" th:href="@{/css/biblioteca.css}">
    <title>Biblioteca Indra S.A. – Panel de Gestión</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/message.js}"></script>
</head>

<body>
    <header>Biblioteca Indra S.A. – Panel de Gestión</header>
<div class="container">
    <!-- === CREAR AUTOR === -->
    <div class="card">
        <h2>Crear Autor</h2>
        <label>Nombre</label>
        <input type="text" id="autorNombre">
        <label>Nacionalidad</label>
        <input type="text" id="autorNacionalidad">
        <label> Fecha Nacimiento</label>
        <input type="datetime-local" id="fechaNac">
        <button onclick="crearAutor()">Crear Autor</button>
    </div>

    <!-- === CREAR LIBRO === -->
    <div class="card">
        <h2>Crear Libro</h2>
        <label>Título</label>
        <input type="text" id="libroTitulo">
        <label>Tipo</label>
        <select id="libroTipo">
            <option value="NOVELA">NOVELA</option>
            <option value="ENSAYO">ENSAYO</option>
            <option value="POESIA">POESIA</option>
            <option value="TEATRO">TEATRO</option>
        </select>
        <label>Editorial</label>
        <input type="text" id="libroEditorial">
        <label>Año</label>
        <input type="number" id="libroAnyo" min="0" value="2025">
        <label>ID Autor</label>
        <input type="number" id="libroAutorId">
        <button onclick="crearLibro()">Crear Libro</button>
    </div>

    <!-- === CREAR COPIAS === -->
    <div class="card">
        <h2>Crear Copias</h2>
        <label>ID Libro</label>
        <input type="number" id="copiaLibroId">
        <label>Número de copias</label>
        <input type="number" id="cantidadCopias">
        <button onclick="crearCopias()">Crear Copias</button>
    </div>
</div>


<div class="container">

    <!-- === PRESTAR === -->
    <div class="card">
        <h2>Prestar</h2>
        <label>ID Lector</label>
        <input type="number" id="prestamoLectorId">
        <label>ID Copia</label>
        <input type="number" id="prestamoCopiaId">
        <button onclick="prestar()">Prestar Libro</button>
    </div>

    <!-- === DEVOLVER === -->
    <div class="card">
        <h2>Devolver Préstamo</h2>
        <label>ID Préstamo</label>
        <input type="number" id="idPrestamo">

        <button onclick="devolver()">Devolver</button>
    </div>

    <!-- === REPARAR / ELIMINAR COPIA === -->
    <div class="card">
        <h2>Gestión de Copias</h2>
        <label>ID Copia</label>
        <input type="number" id="idCopiaGestion">
        <button onclick="repararCopia()">Reparar Copia</button>
        <button onclick="eliminarCopia()">Eliminar Copia</button>
    </div>
</div>


<div class="container">

    <!-- === GET LIBROS === -->
    <div class="card">
        <h2>Consultar Libros</h2>
        <button onclick="getLibros()">Obtener libros</button>
    </div>

    <!-- === GET PRESTAMOS LECTOR === -->
    <div class="card">
        <h2>Préstamos de Lector</h2>
        <label>ID Lector</label>
        <input type="number" id="idLectorPrestamos">

        <button onclick="getPrestamosLector()">Consultar</button>
    </div>
</div>


<!-- === SALIDA DE RESPUESTAS === -->
<div id="output">Aquí aparecerán las respuestas del servidor...</div>


<script>

    // ======= CREAR AUTOR =======
    function crearAutor() {
        $.ajax({
            url: "/biblioteca/crearAutor",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                nombre: $("#autorNombre").val(),
                nacionalidad: $("#autorNacionalidad").val(),
                fechaNac: $("#fechaNac").val()
            }),
            success: r => $("#output").text(JSON.stringify(r, null, 2))
        });
    }

    // ======= CREAR LIBRO =======
    function crearLibro() {
        $.ajax({
            url: "/biblioteca/crearlibro",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                titulo: $("#libroTitulo").val(),
                tipo: $("#libroTipo").val(),
                editorial: $("#libroEditorial").val(),
                anyo: parseInt($("#libroAnyo").val(),10),
                idAutor: parseInt($("#libroAutorId").val(),10)
            }),
            success: r => $("#output").text(JSON.stringify(r, null, 2))
        });
    }

    // ======= CREAR COPIAS =======
    function crearCopias() {
        const idLibro = $("#copiaLibroId").val();
        const ncopias = $("#cantidadCopias").val();

        $.ajax({
            url: "/biblioteca/crearcopia" + encodeURIComponent(idLibro),
            type: "POST",
            data: { ncopias: ncopias }, // va como @RequestParam, no en la ruta
            success: r => $("#output").text(JSON.stringify(r, null, 2)),
            error: e => $("#output").text("Error al crear copias")
        });
    }

    // ======= PRESTAR =======
    function prestar() {
        const idLector = $("#prestamoLectorId").val();
        const idCopia  = $("#prestamoCopiaId").val();

        $.ajax({
            url: "/biblioteca/prestar/" +
                encodeURIComponent(idLector) + "/" +
                encodeURIComponent(idCopia),
            type: "PUT",
            // no hace falta body JSON, los datos van en la URL
            success: r => $("#output").text(JSON.stringify(r, null, 2)),
            error: e => {
                $("#output").text("Error al prestar: " +
                    (e.responseText || e.status + " " + e.statusText));
            }
        });
    }

    // ======= DEVOLVER =======
    function devolver() {
        $.ajax({
            url: "/biblioteca/devolucion" + $("#idPrestamo").val(),
            type: "PUT",
            success: r => $("#output").text(JSON.stringify(r, null, 2))
        });
    }

    // ======= GET LIBROS =======
    function getLibros() {
        $.get("/biblioteca/libros", r => {
            consultarLibros(r);
            $("#output").text("Mostrando " + r.length + " libros en el modal.");
        });
    }

    // ======= GET PRESTAMOS DE LECTOR =======
    function getPrestamosLector() {
        $.get("/biblioteca/prestamosLector/" + $("#idLectorPrestamos").val(), r => {
            $("#output").text(JSON.stringify(r, null, 2));
        });
    }

    function consultarLibros(lista) {
        let html = `
            <table border="1" width="100%" cellpadding="7" style="border-collapse: collapse;">
                <tr style="background:#004fa3;color:white;">
                    <th>Título</th>
                    <th>Tipo</th>
                    <th>Editorial</th>
                    <th>ID Autor</th>
                    <th>Año</th>
                    <th>Nº Copias</th>
                </tr>
        `;

        lista.forEach(l => {
            html += `
                <tr>
                    <td>${l.titulo ?? ""}</td>
                    <td>${l.tipo ?? ""}</td>
                    <td>${l.editorial ?? ""}</td>
                    <td>${l.idAutor ?? ""}</td>
                    <td>${l.anyo ?? ""}</td>
                    <td>${l.numCopias ?? ""}</td>
                </tr>
            `;
        });

        html += "</table>";

        $("#modalTabla").html(html);
        $("#modalFondo").show();
    }
</script>
</body>
</html>